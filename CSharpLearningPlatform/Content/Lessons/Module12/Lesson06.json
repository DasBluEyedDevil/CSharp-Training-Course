{
  "moduleId": 12,
  "lessonNumber": 6,
  "lessonId": "M12L06",
  "title": "Migrations & Bulk Operations (EF Core 8)",
  "simplifierConcept": "MIGRATIONS = Version control for your database schema!\n\nImagine building a house:\n• Version 1: Foundation only\n• Version 2: Add walls\n• Version 3: Add roof\n• Version 4: Add windows\n\nEach step is a MIGRATION:\n• Records what changed\n• Can go forward (apply) or backward (rollback)\n• Track schema evolution in code!\n\nBULK OPERATIONS (NEW in EF Core 7/8):\nOLD way (slow):\n```csharp\nforeach (var product in products)\n{\n    product.Price *= 1.1;  // 10% increase\n}\ncontext.SaveChanges();  // Loads each, updates each - SLOW!\n```\n\nNEW way (fast):\n```csharp\ncontext.Products\n    .Where(p => p.Category == \"Electronics\")\n    .ExecuteUpdate(p => p.SetProperty(x => x.Price, x => x.Price * 1.1));\n// Single UPDATE statement - FAST!\n```\n\nThink: Migrations = 'Git for database schema', Bulk = 'Update 1000 rows in one SQL statement!'",
  "coderExample": "using Microsoft.EntityFrameworkCore;\nusing System;\nusing System.Linq;\n\n// MIGRATIONS (Commands)\n// dotnet ef migrations add InitialCreate\n// dotnet ef database update\n// dotnet ef migrations add AddPriceColumn\n// dotnet ef database update\n\nclass Product\n{\n    public int Id { get; set; }\n    public string Name { get; set; } = string.Empty;\n    public decimal Price { get; set; }\n    public string Category { get; set; } = string.Empty;\n}\n\nclass AppDbContext : DbContext\n{\n    public DbSet<Product> Products { get; set; }\n    \n    protected override void OnConfiguring(DbContextOptionsBuilder optionsBuilder)\n    {\n        optionsBuilder.UseSqlite(\"Data Source=app.db\");\n    }\n}\n\nusing (var context = new AppDbContext())\n{\n    context.Database.EnsureCreated();\n    \n    // Seed data\n    if (!context.Products.Any())\n    {\n        context.Products.AddRange(\n            new Product { Name = \"Laptop\", Price = 1000, Category = \"Electronics\" },\n            new Product { Name = \"Mouse\", Price = 30, Category = \"Electronics\" },\n            new Product { Name = \"Desk\", Price = 200, Category = \"Furniture\" }\n        );\n        context.SaveChanges();\n    }\n    \n    // BULK UPDATE (EF Core 7+)\n    Console.WriteLine(\"=== BULK UPDATE ===\");\n    int updated = context.Products\n        .Where(p => p.Category == \"Electronics\")\n        .ExecuteUpdate(setters => setters\n            .SetProperty(p => p.Price, p => p.Price * 1.1m));\n    \n    Console.WriteLine($\"Updated {updated} products with single SQL!\");\n    // Generated SQL: UPDATE Products SET Price = Price * 1.1 WHERE Category = 'Electronics'\n    \n    // BULK DELETE (EF Core 7+)\n    Console.WriteLine(\"\\n=== BULK DELETE ===\");\n    int deleted = context.Products\n        .Where(p => p.Price < 50)\n        .ExecuteDelete();\n    \n    Console.WriteLine($\"Deleted {deleted} products\");\n    // Generated SQL: DELETE FROM Products WHERE Price < 50\n    \n    // TRADITIONAL UPDATE (for comparison - slower!)\n    var products = context.Products.Where(p => p.Category == \"Furniture\").ToList();\n    foreach (var p in products)\n    {\n        p.Price *= 1.05m;  // 5% increase\n    }\n    context.SaveChanges();  // Separate UPDATE for each!\n}\n\n// MIGRATION WORKFLOW:\n// 1. Change your entity classes (add/remove properties)\n// 2. Run: dotnet ef migrations add DescriptiveName\n// 3. Review generated migration code\n// 4. Run: dotnet ef database update\n// 5. Database schema updated!\n\n// MIGRATION COMMANDS:\n// List migrations: dotnet ef migrations list\n// Remove last:     dotnet ef migrations remove\n// Rollback:        dotnet ef database update PreviousMigration\n// Generate SQL:    dotnet ef migrations script",
  "syntaxBreakdown": [
    {
      "codeSnippet": "ExecuteUpdate()",
      "explanation": "EF Core 7+ feature. Updates multiple rows with single SQL! SetProperty(prop, value). Returns number of affected rows. WAY faster than load-modify-save!"
    },
    {
      "codeSnippet": "ExecuteDelete()",
      "explanation": "EF Core 7+ feature. Deletes multiple rows with single SQL! No loading into memory. Executes immediately (not on SaveChanges!)."
    },
    {
      "codeSnippet": "Migrations add",
      "explanation": "dotnet ef migrations add Name - Creates migration file with Up() and Down() methods. Snapshot of schema changes."
    },
    {
      "codeSnippet": "database update",
      "explanation": "dotnet ef database update - Applies pending migrations to database. Updates schema to match code!"
    }
  ],
  "challenge": {
    "instructions": "Demonstrate migrations and bulk operations!\n\n1. Create 'Employee' entity:\n   - int Id\n   - string Name\n   - decimal Salary\n   - string Department\n\n2. Create 'CompanyDbContext'\n\n3. Show migration workflow (print commands):\n   - Print: dotnet ef migrations add InitialCreate\n   - Print: dotnet ef database update\n   - Print: (Add new property 'bool IsActive')\n   - Print: dotnet ef migrations add AddIsActive\n   - Print: dotnet ef database update\n\n4. Simulate bulk operations:\n   - BULK UPDATE: Give 10% raise to 'Engineering' department\n   - Print SQL that would execute\n   - BULK DELETE: Remove employees with salary < 30000\n   - Print SQL that would execute\n\n5. Compare with traditional approach:\n   - Show foreach loop version (slow)\n   - Show bulk version (fast)\n   - Explain performance difference",
    "starterCode": "using Microsoft.EntityFrameworkCore;\nusing System;\nusing System.Linq;\n\nclass Employee\n{\n    public int Id { get; set; }\n    public string Name { get; set; } = string.Empty;\n    public decimal Salary { get; set; }\n    public string Department { get; set; } = string.Empty;\n}\n\nclass CompanyDbContext : DbContext\n{\n    public DbSet<Employee> Employees { get; set; }\n    \n    protected override void OnConfiguring(DbContextOptionsBuilder optionsBuilder)\n    {\n        optionsBuilder.UseSqlite(\"Data Source=company.db\");\n    }\n}\n\nConsole.WriteLine(\"=== MIGRATIONS WORKFLOW ===\");\nConsole.WriteLine(\"\\n1. Create initial entities and DbContext\");\nConsole.WriteLine(\"   Command: dotnet ef migrations add InitialCreate\");\nConsole.WriteLine(\"   Result: Creates Migrations/InitialCreate.cs\");\n\nConsole.WriteLine(\"\\n2. Apply migration to database\");\nConsole.WriteLine(\"   Command: dotnet ef database update\");\nConsole.WriteLine(\"   Result: Database created with Employees table\");\n\nConsole.WriteLine(\"\\n3. Add new property to Employee class\");\nConsole.WriteLine(\"   Code: public bool IsActive { get; set; }\");\n\nConsole.WriteLine(\"\\n4. Create migration for new property\");\nConsole.WriteLine(\"   Command: dotnet ef migrations add AddIsActive\");\nConsole.WriteLine(\"   Result: Migration file for schema change\");\n\nConsole.WriteLine(\"\\n5. Apply the migration\");\nConsole.WriteLine(\"   Command: dotnet ef database update\");\nConsole.WriteLine(\"   Result: IsActive column added to Employees table\");\n\nConsole.WriteLine(\"\\n=== BULK OPERATIONS (EF Core 7+) ===\");\n\nConsole.WriteLine(\"\\nBULK UPDATE: 10% raise for Engineering\");\nConsole.WriteLine(\"Code:\");\nConsole.WriteLine(\"  context.Employees\");\nConsole.WriteLine(\"    .Where(e => e.Department == 'Engineering')\");\nConsole.WriteLine(\"    .ExecuteUpdate(s => s.SetProperty(e => e.Salary, e => e.Salary * 1.1m));\");\nConsole.WriteLine(\"\\nGenerated SQL:\");\nConsole.WriteLine(\"  UPDATE Employees SET Salary = Salary * 1.1 WHERE Department = 'Engineering'\");\nConsole.WriteLine(\"✓ FAST: Single SQL statement!\");\n\nConsole.WriteLine(\"\\nBULK DELETE: Remove low-salary employees\");\nConsole.WriteLine(\"Code:\");\nConsole.WriteLine(\"  context.Employees.Where(e => e.Salary < 30000).ExecuteDelete();\");\nConsole.WriteLine(\"\\nGenerated SQL:\");\nConsole.WriteLine(\"  DELETE FROM Employees WHERE Salary < 30000\");\nConsole.WriteLine(\"✓ FAST: Single SQL statement!\");\n\nConsole.WriteLine(\"\\n=== PERFORMANCE COMPARISON ===\");\nConsole.WriteLine(\"\\nTRADITIONAL (Slow):\");\nConsole.WriteLine(\"  var employees = context.Employees.Where(e => ...).ToList();\");\nConsole.WriteLine(\"  foreach (var e in employees) { e.Salary *= 1.1; }\");\nConsole.WriteLine(\"  context.SaveChanges();\");\nConsole.WriteLine(\"  Result: 1000 employees = 1000 UPDATE statements!\");\n\nConsole.WriteLine(\"\\nBULK (Fast):\");\nConsole.WriteLine(\"  context.Employees.Where(e => ...).ExecuteUpdate(...);\");\nConsole.WriteLine(\"  Result: 1000 employees = 1 UPDATE statement!\");\nConsole.WriteLine(\"  Performance: 100x-1000x faster for large datasets!\");",
    "solutionCode": "using Microsoft.EntityFrameworkCore;\nusing System;\nusing System.Linq;\n\nclass Employee\n{\n    public int Id { get; set; }\n    public string Name { get; set; } = string.Empty;\n    public decimal Salary { get; set; }\n    public string Department { get; set; } = string.Empty;\n}\n\nclass CompanyDbContext : DbContext\n{\n    public DbSet<Employee> Employees { get; set; }\n    \n    protected override void OnConfiguring(DbContextOptionsBuilder optionsBuilder)\n    {\n        optionsBuilder.UseSqlite(\"Data Source=company.db\");\n    }\n}\n\nConsole.WriteLine(\"═══════════════════════════════════════════\");\nConsole.WriteLine(\"  EF CORE 8: MIGRATIONS & BULK OPERATIONS\");\nConsole.WriteLine(\"═══════════════════════════════════════════\\n\");\n\nConsole.WriteLine(\"=== PART 1: MIGRATIONS WORKFLOW ===\");\nConsole.WriteLine(\"\\nStep 1: Create Initial Schema\");\nConsole.WriteLine(\"  → dotnet ef migrations add InitialCreate\");\nConsole.WriteLine(\"  Creates: Migrations/20240115120000_InitialCreate.cs\");\nConsole.WriteLine(\"  Contains: Up() creates Employees table, Down() drops it\\n\");\n\nConsole.WriteLine(\"Step 2: Apply to Database\");\nConsole.WriteLine(\"  → dotnet ef database update\");\nConsole.WriteLine(\"  Result: Database created with schema from code\\n\");\n\nConsole.WriteLine(\"Step 3: Evolve Schema (Add property)\");\nConsole.WriteLine(\"  Code change: public bool IsActive { get; set; }\");\nConsole.WriteLine(\"  → dotnet ef migrations add AddIsActive\");\nConsole.WriteLine(\"  Creates: New migration file\\n\");\n\nConsole.WriteLine(\"Step 4: Apply New Migration\");\nConsole.WriteLine(\"  → dotnet ef database update\");\nConsole.WriteLine(\"  Result: IsActive column added to table\");\nConsole.WriteLine(\"  ✓ Database schema evolves with code!\");\n\nConsole.WriteLine(\"\\n=== PART 2: BULK OPERATIONS (EF Core 7+) ===\");\n\nConsole.WriteLine(\"\\n[BULK UPDATE] 10% raise for Engineering department\");\nConsole.WriteLine(\"\\n  OLD WAY (Slow):\");\nConsole.WriteLine(\"    var engineers = context.Employees\");\nConsole.WriteLine(\"                          .Where(e => e.Department == 'Engineering')\");\nConsole.WriteLine(\"                          .ToList();  // Load into memory\");\nConsole.WriteLine(\"    foreach (var e in engineers)\");\nConsole.WriteLine(\"        e.Salary *= 1.1m;\");\nConsole.WriteLine(\"    context.SaveChanges();  // N UPDATE statements!\");\nConsole.WriteLine(\"    Performance: 1000 rows = 1000 database round-trips\\n\");\n\nConsole.WriteLine(\"  NEW WAY (Fast):\");\nConsole.WriteLine(\"    context.Employees\");\nConsole.WriteLine(\"        .Where(e => e.Department == 'Engineering')\");\nConsole.WriteLine(\"        .ExecuteUpdate(s => s.SetProperty(e => e.Salary, e => e.Salary * 1.1m));\");\nConsole.WriteLine(\"\\n    Generated SQL:\");\nConsole.WriteLine(\"      UPDATE Employees \");\nConsole.WriteLine(\"      SET Salary = Salary * 1.1 \");\nConsole.WriteLine(\"      WHERE Department = 'Engineering'\");\nConsole.WriteLine(\"\\n    Performance: 1000 rows = 1 database statement!\");\nConsole.WriteLine(\"    ✓ 100x-1000x FASTER!\\n\");\n\nConsole.WriteLine(\"[BULK DELETE] Remove employees with salary < $30,000\");\nConsole.WriteLine(\"\\n  Code:\");\nConsole.WriteLine(\"    int deleted = context.Employees\");\nConsole.WriteLine(\"        .Where(e => e.Salary < 30000)\");\nConsole.WriteLine(\"        .ExecuteDelete();\");\nConsole.WriteLine(\"\\n  Generated SQL:\");\nConsole.WriteLine(\"    DELETE FROM Employees WHERE Salary < 30000\");\nConsole.WriteLine(\"\\n  ✓ Single SQL statement, no loading into memory!\");\n\nConsole.WriteLine(\"\\n=== KEY BENEFITS ===\");\nConsole.WriteLine(\"\\nMigrations:\");\nConsole.WriteLine(\"  ✓ Version control for database schema\");\nConsole.WriteLine(\"  ✓ Rollback capability (go to previous version)\");\nConsole.WriteLine(\"  ✓ Team-friendly (migrations in source control)\");\nConsole.WriteLine(\"  ✓ Deployment automation (apply on production)\");\n\nConsole.WriteLine(\"\\nBulk Operations:\");\nConsole.WriteLine(\"  ✓ Massive performance gains (100x+)\");\nConsole.WriteLine(\"  ✓ Less memory usage (no loading into C#)\");\nConsole.WriteLine(\"  ✓ Atomic operations (all-or-nothing)\");\nConsole.WriteLine(\"  ✓ Database-side execution (efficient!)\");",
    "hint": "Migrations: dotnet ef migrations add Name, dotnet ef database update. Bulk: .ExecuteUpdate(s => s.SetProperty()), .ExecuteDelete(). Bulk = single SQL, traditional = N SQL statements!",
    "expectedOutputPatterns": ["MIGRATIONS", "BULK OPERATIONS", "ExecuteUpdate", "ExecuteDelete", "dotnet ef", "FASTER"],
    "validationRules": [],
    "commonStickingPoints": [
      "Migrations without EF tools: Must install 'dotnet ef' CLI tool! Run 'dotnet tool install --global dotnet-ef'. Also need Microsoft.EntityFrameworkCore.Design package!",
      "Production migration: Don't use EnsureCreated() in production! Use migrations. EnsureCreated() can't update schema. Migrations = professional approach.",
      "Bulk operations and tracking: ExecuteUpdate/Delete DON'T update change tracker! If entities loaded, they're now stale. Either reload or don't mix bulk with tracking.",
      "ExecuteUpdate syntax: SetProperty takes TWO lambdas: property selector AND value expression. 's => s.SetProperty(e => e.Price, e => e.Price * 1.1)'. Easy to forget second lambda!"
    ]
  }
}
